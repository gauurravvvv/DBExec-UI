<div class="dataset-page-wrapper">
  <div class="dataset-content-container">

    <!-- Header Section -->
    <div class="page-header-section">
      <div class="header-content">
        <h2>Databases</h2>
      </div>
    </div>

    <!-- Unified Toolbar & Content Card -->
    <div class="content-card">
      <div class="card-toolbar">
        <div class="toolbar-left">
          <!-- Organisation Dropdown -->
          <div class="dropdown-field" *ngIf="showOrganisationDropdown">
            <app-custom-dropdown [(ngModel)]="selectedOrg" [options]="organisations" optionLabel="name" optionValue="id"
              [filter]="true" label="Organisation" [floatingLabel]="true" filterBy="name"
              (onChangeEvent)="onOrgChange($event)">
            </app-custom-dropdown>
          </div>
        </div>

        <div class="toolbar-right">
          <!-- Search -->
          <span class="p-input-icon-left search-input-wrapper">
            <i class="pi pi-search"></i>
            <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
              placeholder="Search..." class="modern-search" />
          </span>

          <!-- Add Button -->
          <button pButton label="Add" icon="pi pi-plus" (click)="onAddNewDatabase()"
            class="p-button-raised p-button-primary modern-button">
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <p-table #dt [value]="dbs" [rows]="10" [paginator]="true"
          [globalFilterFields]="['name', 'config.dbType', 'status']" [rowHover]="true" dataKey="id"
          currentPageReportTemplate="{first} - {last} of {totalRecords}" [showCurrentPageReport]="true"
          [rowsPerPageOptions]="[10,25,50,100]" styleClass="p-datatable-sm modern-table" [scrollable]="true"
          scrollHeight="calc(100vh - 400px)">

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="name" style="width: 25%">
                <div class="th-content">
                  Name <p-sortIcon field="name"></p-sortIcon>
                </div>
              </th>
              <th style="width: 25%">
                <div class="th-content">
                  Description
                </div>
              </th>
              <th pSortableColumn="config.dbType" style="width: 15%">
                <div class="th-content">
                  Type <p-sortIcon field="config.dbType"></p-sortIcon>
                </div>
              </th>
              <th pSortableColumn="status" style="width: 15%">
                <div class="th-content">
                  Status <p-sortIcon field="status"></p-sortIcon>
                </div>
              </th>
              <th pSortableColumn="createdOn" style="width: 15%">
                <div class="th-content">
                  Created <p-sortIcon field="createdOn"></p-sortIcon>
                </div>
              </th>
              <th style="width: 5%">
                <!-- Actions -->
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-db>
            <tr class="modern-row">
              <td>
                <a class="dataset-name-link"
                  [routerLink]="['/app/database/view', db.organisationId, db.id, db.isMasterDB ? 1 : 0]">
                  <i class="pi pi-database" style="margin-right: 8px;"></i>
                  {{ db.name }}
                  <span class="master-badge" *ngIf="db.isMasterDB">
                    <i class="pi pi-star-fill"></i>
                    Master
                  </span>
                </a>
              </td>
              <td>
                <span class="description-text" [title]="db.description">{{ db.description || 'No description' }}</span>
              </td>
              <td>
                <span class="pill">{{ db.config.dbType || 'Standard' }}</span>
              </td>
              <td>
                <span class="status-indicator" [ngClass]="{'active': db.status === 1, 'inactive': db.status !== 1}">
                  <span class="dot"></span>
                  {{ db.status === 1 ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <span class="date-text">{{ db.createdOn | date:'mediumDate' }}</span>
              </td>
              <td>
                <div class="row-actions">
                  <button class="icon-btn edit-btn" (click)="onEdit(db.id)" pTooltip="Edit" tooltipPosition="left">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button class="icon-btn delete-btn" (click)="confirmDelete(db)" pTooltip="Delete"
                    tooltipPosition="left">
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="empty-message-cell">
                No such record found
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<div class="confirmation-popup" *ngIf="showDeleteConfirm">
  <div class="popup-content">
    <h3>Confirm Delete</h3>
    <p>Are you sure you want to delete this database?</p>

    <!-- Special warning for master database -->
    <div class="warning-container" *ngIf="selectedDatabase?.isMasterDB">
      <div class="warning-message">
        <div class="warning-header">
          <i class="pi pi-exclamation-triangle"></i>
          <span class="warning-title">Critical Warning: Master Database</span>
        </div>
        <div class="warning-content">
          <div class="warning-text">
            <p>
              <i class="pi pi-circle-fill"></i>You are attempting to delete a
              master database that controls core system operations.
            </p>
            <p>
              <i class="pi pi-circle-fill"></i>Deleting this database will
              permanently remove all system configurations and cannot be
              undone.
            </p>
            <p>
              <i class="pi pi-circle-fill"></i>You will need to create a new
              master database to restore system functionality and continue
              operations.
            </p>
            <p>
              <i class="pi pi-circle-fill"></i>Please ensure you have taken a
              complete backup of all configurations and data before
              proceeding.
            </p>
            <p>
              <i class="pi pi-circle-fill"></i>This action requires immediate
              system reconfiguration after deletion.
            </p>
            <p class="warning-checkbox">
              <p-checkbox [(ngModel)]="deleteConfiguration" [binary]="true" inputId="deleteConfig">
              </p-checkbox>
              <label for="deleteConfig">
                Do you want to delete the database data too that are required
                for system operations?
              </label>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="popup-actions">
      <button class="btn-cancel" (click)="cancelDelete()">No</button>
      <button class="btn-confirm" (click)="proceedDelete()">Yes</button>
    </div>
  </div>
</div>