<div class="dataset-page-wrapper">
  <div class="dataset-content-container">

    <!-- Header Section -->
    <div class="page-header-section">
      <div class="header-content">
        <h2>Databases</h2>
      </div>
    </div>

    <!-- Unified Toolbar & Content Card -->
    <div class="content-card">
      <div class="card-toolbar">
        <div class="toolbar-left">
          <!-- Organisation Dropdown -->
          <div class="dropdown-field" *ngIf="showOrganisationDropdown">
            <app-custom-dropdown [(ngModel)]="selectedOrg" [options]="organisations" optionLabel="name" optionValue="id"
              [filter]="true" label="Organisation" [floatingLabel]="true" filterBy="name"
              (onChangeEvent)="onOrgChange($event)">
            </app-custom-dropdown>
          </div>
        </div>

        <div class="toolbar-right">
          <!-- Clear Filters Button -->
          <button pButton label="Clear Filters" icon="pi pi-filter-slash" (click)="clearFilters()"
            [disabled]="!isFilterActive" class="p-button-outlined p-button-danger modern-button mr-2">
          </button>

          <!-- Add Button -->
          <button pButton label="Add" icon="pi pi-plus" (click)="onAddNewDatabase()"
            class="p-button-raised p-button-primary modern-button">
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <p-table #dt [value]="dbs" [rows]="10" [paginator]="true" [lazy]="true" (onLazyLoad)="loadDatabases($event)"
          [totalRecords]="totalItems" [globalFilterFields]="['name', 'description', 'config.dbType', 'status']"
          [rowHover]="true" dataKey="id" currentPageReportTemplate="{first} - {last} of {totalRecords}"
          [showCurrentPageReport]="true" [rowsPerPageOptions]="[10,25,50,100]" styleClass="p-datatable-sm modern-table"
          [scrollable]="true" scrollHeight="calc(100vh - 400px)">

          <ng-template pTemplate="header">
            <tr>
              <th style="width: 25%" pFrozenColumn>
                <div class="th-content">
                  Name
                </div>
              </th>
              <th style="width: 25%">
                <div class="th-content">
                  Description
                </div>
              </th>
              <th style="width: 15%">
                <div class="th-content">
                  Type
                </div>
              </th>
              <th style="width: 15%">
                <div class="th-content">
                  Status
                </div>
              </th>
              <th style="width: 15%">
                <div class="th-content">
                  Created
                </div>
              </th>
              <th style="width: 5%">
                <!-- Actions -->
              </th>
            </tr>
            <!-- Filter Row -->
            <tr>
              <th pFrozenColumn>
                <input pInputText type="text" [(ngModel)]="filterValues.name" (input)="onFilterChange()"
                  placeholder="Search Name" class="w-full p-column-filter">
              </th>
              <th>
                <input pInputText type="text" [(ngModel)]="filterValues.description" (input)="onFilterChange()"
                  placeholder="Search Description" class="w-full p-column-filter">
              </th>
              <th>
                <!-- No filter for Type currently, or add if needed. Keeping it empty for now as requested filter list was Name, Desc, Status -->
              </th>
              <th>
                <!-- <p-dropdown [options]="statusOptions" [(ngModel)]="filterValues.status" (onChange)="onFilterChange()"
                  placeholder="Select Status" [showClear]="true" [style]="{'width':'100%'}" appendTo="body"
                  styleClass="w-full p-column-filter">
                </p-dropdown> -->
              </th>
              <th>
                <!-- No filter for Created On -->
              </th>
              <th>
                <!-- No filter for Actions -->
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-db>
            <tr class="modern-row">
              <td pFrozenColumn>
                <a class="dataset-name-link"
                  [routerLink]="['/app/database/view', db.organisationId, db.id, db.isMasterDB ? 1 : 0]">
                  {{ db.name }}
                  <span class="master-badge" *ngIf="db.isMasterDB">
                    <i class="pi pi-star-fill"></i>
                    Master
                  </span>
                </a>
              </td>
              <td>
                <span class="description-text" [title]="db.description">{{ db.description || '-' }}</span>
              </td>
              <td>
                <span class="pill">{{ 'PostgreSQL' }}</span>
              </td>
              <td>
                <span class="status-indicator" [ngClass]="{'active': db.status === 1, 'inactive': db.status !== 1}">
                  <span class="dot"></span>
                  {{ db.status === 1 ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <span class="date-text">{{ db.createdOn | date:'medium' }}</span>
              </td>
              <td>
                <div class="row-actions">
                  <button class="icon-btn edit-btn" (click)="onEdit(db.id)" pTooltip="Edit" tooltipPosition="left">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button class="icon-btn delete-btn" (click)="confirmDelete(db)" pTooltip="Delete"
                    tooltipPosition="left">
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="empty-message-cell text-center">
                No such record found
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<div class="confirmation-popup" *ngIf="showDeleteConfirm">
  <div class="popup-content" [class.master-warning]="selectedDatabase?.isMasterDB">
    <!-- Header -->
    <div class="popup-header">
      <div class="popup-icon" [class.danger]="selectedDatabase?.isMasterDB">
        <i class="pi" [ngClass]="selectedDatabase?.isMasterDB ? 'pi-exclamation-triangle' : 'pi-trash'"></i>
      </div>
      <h3>{{ selectedDatabase?.isMasterDB ? 'Critical Warning' : 'Confirm Delete' }}</h3>
    </div>

    <!-- Standard Delete Section (Non-Master DB) -->
    <div class="standard-delete-section" *ngIf="!selectedDatabase?.isMasterDB">
      <div class="db-info-badge">
        <i class="pi pi-database"></i>
        <span>{{ selectedDatabase?.name }}</span>
      </div>

      <p class="delete-intro">
        Are you sure you want to delete this database?
      </p>

      <ul class="delete-info-list">
        <li>
          <i class="pi pi-info-circle"></i>
          <span>All associated data will be removed</span>
        </li>
        <li>
          <i class="pi pi-info-circle"></i>
          <span>Connected datasets will be affected</span>
        </li>
        <li>
          <i class="pi pi-info-circle"></i>
          <span>This action cannot be undone</span>
        </li>
      </ul>
    </div>

    <!-- Master DB Warning Section -->
    <div class="master-warning-section" *ngIf="selectedDatabase?.isMasterDB">
      <div class="warning-badge">
        <i class="pi pi-database"></i>
        <span>Master Database</span>
      </div>

      <p class="warning-intro">
        You are about to delete <strong>{{ selectedDatabase?.name }}</strong>, which is the master database.
      </p>

      <ul class="warning-list">
        <li>
          <i class="pi pi-exclamation-circle"></i>
          <span>Controls core system operations</span>
        </li>
        <li>
          <i class="pi pi-exclamation-circle"></i>
          <span>Permanently removes all configurations</span>
        </li>
        <li>
          <i class="pi pi-exclamation-circle"></i>
          <span>Requires system reconfiguration</span>
        </li>
        <li>
          <i class="pi pi-exclamation-circle"></i>
          <span>Cannot be undone</span>
        </li>
      </ul>

      <div class="checkbox-option">
        <p-checkbox [(ngModel)]="deleteConfiguration" [binary]="true" inputId="deleteConfig">
        </p-checkbox>
        <label for="deleteConfig">
          Also delete associated system data
        </label>
      </div>
    </div>

    <!-- Actions -->
    <div class="popup-actions">
      <button class="btn-cancel" (click)="cancelDelete()">
        <i class="pi pi-times"></i>
        Cancel
      </button>
      <button class="btn-confirm" (click)="proceedDelete()">
        <i class="pi pi-trash"></i>
        {{ selectedDatabase?.isMasterDB ? 'Delete Master DB' : 'Delete' }}
      </button>
    </div>
  </div>
</div>