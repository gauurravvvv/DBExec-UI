<div class="add-admin-wrapper">
    <div class="add-admin-container">
        <div class="page-header">
            <div class="left-section">
                <button pButton class="p-button-text" routerLink="/app/prompt">
                    <i class="pi pi-arrow-left"></i>
                </button>
                <h2>Configure Prompt</h2>
            </div>
            <div class="action-buttons">
                <button pButton type="button" label="Customise" class="p-button-outlined" *ngIf="isConfigurable()"
                    (click)="openConfigDialog()" pTooltip="Customise prompt display options" tooltipPosition="bottom">
                    <i class="pi pi-cog mr-2"></i>
                </button>
                <button pButton type="button" label="Cancel" class="p-button-outlined p-button-danger"
                    [disabled]="!isFormDirty || isCancelClicked" (click)="onCancel()">
                </button>
                <button pButton class="p-button-outlined" type="submit" label="Save" (click)="onSubmit()"
                    [disabled]="promptForm.invalid || !isFormDirty">
                    <i class="pi pi-save mr-2"></i>
                </button>
            </div>
        </div>
        <form [formGroup]="promptForm" class="admin-form" #formContainer>
            <div class="form-container">
                <div class="form-grid left-column">
                    <div class="form-row full-width">
                        <div class="form-field half-width">
                            <label for="name">Name</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-tag"></i>
                                <input id="name" type="text" pInputText [value]="promptForm.get('name')?.value"
                                    disabled>
                            </span>
                        </div>

                        <div class="form-field half-width">
                            <label for="name">Type</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-tag"></i>
                                <input id="name" type="text" pInputText [value]="promptForm.get('type')?.value"
                                    disabled>
                            </span>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-field" *ngIf="showOrganisationDropdown">
                            <label for="organisation">Organisation</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-building"></i>
                                <input id="organisation" type="text" pInputText [value]="selectedOrgName" disabled>
                            </span>
                        </div>
                        <div class="form-field">
                            <label for="database">Database</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-database"></i>
                                <input id="database" type="text" pInputText [value]="selectedDatabaseName" disabled>
                            </span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="tab">Tab</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-box"></i>
                                <input id="tab" type="text" pInputText [value]="selectedTabName" disabled>
                            </span>
                        </div>
                        <div class="form-field">
                            <label for="section">Section</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-box"></i>
                                <input id="section" type="text" pInputText [value]="selectedSectionName" disabled>
                            </span>
                        </div>
                    </div>
                    <div class="section-header">
                        <h3>
                            <i class="pi pi-database mr-2"></i>
                            Query Configurations
                        </h3>
                    </div>
                    <div class="form-row schema-table-row">
                        <div class="form-field schema-field">
                            <app-custom-dropdown formControlName="schema" label="Schema" placeholder="Select Schema"
                                [options]="schemas" optionLabel="name" [optionValue]="null" [filter]="true"
                                filterBy="name" [required]="true"
                                [showError]="!!(promptForm.get('schema')?.invalid && promptForm.get('schema')?.touched)"
                                errorMessage="Schema is required">
                            </app-custom-dropdown>
                        </div>
                        <div class="form-field">
                            <app-custom-multiselect formControlName="tables" label="Table(s)"
                                placeholder="Select Tables"
                                [options]="getAvailableTables(promptForm.get('schema')?.value)" optionLabel="name"
                                optionValue="value" [filter]="true" filterBy="name" display="chip" [required]="true"
                                [showError]="!!(promptForm.get('tables')?.invalid && promptForm.get('tables')?.touched)"
                                errorMessage="At least one table is required">
                            </app-custom-multiselect>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 0">
                        <div class="form-field full-width">
                            <app-custom-multiselect formControlName="columns" label="Column(s)"
                                placeholder="Select Columns" [options]="availableColumns" optionLabel="displayName"
                                [filter]="true" filterBy="displayName,columnName" display="chip" [showToggleAll]="true"
                                [required]="true"
                                [showError]="!!(promptForm.get('columns')?.invalid && promptForm.get('columns')?.touched)"
                                errorMessage="At least one column is required">
                            </app-custom-multiselect>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 1">
                        <div class="form-field full-width">
                            <label for="promptJoin">
                                Prompt Join Condition<span class="required">*</span>
                                <i class="pi pi-info-circle info-icon"
                                    pTooltip="Type alias followed by '.' for column suggestions."
                                    tooltipPosition="right"></i>
                            </label>
                            <div class="autocomplete-container">
                                <span class="p-input-icon-left full-width">
                                    <i class="pi pi-link"></i>
                                    <input id="promptJoin" type="text" pInputText formControlName="promptJoin"
                                        (input)="onJoinConditionInput($event)" (keydown)="onJoinKeydown($event)"
                                        (blur)="hideJoinSuggestionsDelayed()" (focus)="onJoinFocus($event)"
                                        placeholder="Example: o.user_id = u.id" autocomplete="off"
                                        [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptJoin')?.invalid && promptForm.get('promptJoin')?.touched}">
                                </span>

                                <!-- Enhanced Autocomplete Dropdown for Join -->
                                <div class="column-suggestions"
                                    *ngIf="showJoinSuggestions && filteredJoinColumns.length > 0">
                                    <div class="suggestions-header">
                                        <span>{{ filteredJoinColumns.length }} column(s) found</span>
                                        <span class="keyboard-hint">↑↓ Navigate • Enter Select • Esc Close</span>
                                    </div>
                                    <div class="suggestions-list">
                                        <div class="suggestion-item"
                                            *ngFor="let column of filteredJoinColumns.slice(0, maxSuggestions); let i = index"
                                            [class.selected]="i === selectedJoinSuggestionIndex"
                                            (mousedown)="selectJoinSuggestion(column)"
                                            (mouseenter)="selectedJoinSuggestionIndex = i">
                                            <i class="pi pi-hashtag column-icon"></i>
                                            <span class="column-name">{{ column.name }}</span>
                                            <span class="column-type">{{ column.type }}</span>
                                        </div>
                                    </div>
                                    <div class="suggestions-footer" *ngIf="filteredJoinColumns.length > maxSuggestions">
                                        <span>Showing {{ maxSuggestions }} of {{ filteredJoinColumns.length }} results.
                                            Type more to filter.</span>
                                    </div>
                                </div>

                                <!-- No Results Message -->
                                <div class="column-suggestions no-results"
                                    *ngIf="showJoinSuggestions && filteredJoinColumns.length === 0 && currentJoinAlias">
                                    <div class="no-results-content">
                                        <i class="pi pi-search"></i>
                                        <span>No columns found for "{{ currentJoinAlias }}"</span>
                                    </div>
                                </div>
                            </div>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptJoin')?.invalid && promptForm.get('promptJoin')?.touched">
                                Join condition is required
                            </small>
                            <small class="hint-text">
                                <i class="pi pi-lightbulb"></i>
                                Use <code>1=1</code> if no specific join condition is required.
                            </small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field full-width">
                            <label for="promptWhere">
                                Prompt Where Condition<span class="required">*</span>
                                <i class="pi pi-info-circle info-icon"
                                    pTooltip="Specify the filter condition. Type alias.column followed by operator"
                                    tooltipPosition="right"></i>
                            </label>
                            <div class="autocomplete-container">
                                <span class="p-input-icon-left full-width">
                                    <i class="pi pi-filter"></i>
                                    <input id="promptWhere" type="text" pInputText formControlName="promptWhere"
                                        (input)="onWhereConditionInput($event)" (keydown)="onWhereKeydown($event)"
                                        (blur)="hideSuggestionsDelayed()" (focus)="onWhereFocus($event)"
                                        placeholder="Enter where condition" autocomplete="off"
                                        [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptWhere')?.invalid && promptForm.get('promptWhere')?.touched}">
                                </span>

                                <!-- Enhanced Autocomplete Dropdown -->
                                <div class="column-suggestions" *ngIf="showSuggestions && filteredColumns.length > 0">
                                    <div class="suggestions-header">
                                        <span>{{ filteredColumns.length }} column(s) found</span>
                                        <span class="keyboard-hint">↑↓ Navigate • Enter Select • Esc Close</span>
                                    </div>
                                    <div class="suggestions-list">
                                        <div class="suggestion-item"
                                            *ngFor="let column of filteredColumns.slice(0, maxSuggestions); let i = index"
                                            [class.selected]="i === selectedSuggestionIndex"
                                            (mousedown)="selectSuggestion(column)"
                                            (mouseenter)="selectedSuggestionIndex = i">
                                            <i class="pi pi-hashtag column-icon"></i>
                                            <span class="column-name">{{ column.name }}</span>
                                            <span class="column-type">{{ column.type }}</span>
                                        </div>
                                    </div>
                                    <div class="suggestions-footer" *ngIf="filteredColumns.length > maxSuggestions">
                                        <span>Showing {{ maxSuggestions }} of {{ filteredColumns.length }} results. Type
                                            more to filter.</span>
                                    </div>
                                </div>

                                <!-- No Results Message -->
                                <div class="column-suggestions no-results"
                                    *ngIf="showSuggestions && filteredColumns.length === 0 && currentAlias">
                                    <div class="no-results-content">
                                        <i class="pi pi-search"></i>
                                        <span>No columns found for "{{ currentAlias }}"</span>
                                    </div>
                                </div>
                            </div>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptWhere')?.invalid && promptForm.get('promptWhere')?.touched">
                                Where condition is required
                            </small>
                            <small class="hint-text" *ngIf="promptForm.get('tables')?.value?.length > 0">
                                <i class="pi pi-lightbulb"></i>
                                <span *ngIf="isRangeType()">
                                    <strong>Range prompts:</strong> Use <code>{{'{'}}startValue{{'}'}}</code> and
                                    <code>{{'{'}}endValue{{'}'}}</code> as placeholders.
                                    <br>Example:
                                    <code>alias.column BETWEEN '{{'{'}}startValue{{'}'}}' AND '{{'{'}}endValue{{'}'}}'</code>
                                </span>
                                <span *ngIf="isMultiValueType()">
                                    <strong>Multi-value prompts:</strong> Use <code>{{'{'}}value{{'}'}}</code> as
                                    placeholder.
                                    <br>Example: <code>alias.column IN ('{{'{'}}value{{'}'}}')</code>
                                </span>
                                <span *ngIf="!isRangeType() && !isMultiValueType()">
                                    <strong>Single-value prompts:</strong> Use <code>{{'{'}}value{{'}'}}</code> as
                                    placeholder.
                                    <br>Example: <code>alias.column = '{{'{'}}value{{'}'}}'</code>
                                </span>
                            </small>
                        </div>
                    </div>

                    <!-- Live SQL Preview Section -->
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 0">
                        <div class="form-field full-width">
                            <div class="section-header sql-preview-header">
                                <h3>
                                    <i class="pi pi-code mr-2"></i>
                                    SQL Preview
                                </h3>
                                <button type="button" pButton class="p-button-text p-button-rounded p-button-sm"
                                    icon="pi pi-copy" pTooltip="Copy SQL" tooltipPosition="left"
                                    (click)="copySqlToClipboard()">
                                </button>
                            </div>
                            <div class="sql-preview-container">
                                <pre class="sql-preview-code"><code>{{ generateSqlPreview() }}</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="section-header" *ngIf="showAddPromptValues">
                        <h3>
                            <i class="pi pi-list mr-2"></i>
                            Prompt Configuration
                        </h3>
                    </div>
                    <div class="form-row" *ngIf="showAddPromptValues">
                        <div class="form-field">
                            <div class="label-with-clear"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label for="promptValues" style="margin-bottom: 0;">
                                    Prompt Values<span class="required">*</span>
                                    <i class="pi pi-info-circle info-icon"
                                        pTooltip="Add selectable options. Press Enter or Comma to add each value"
                                        tooltipPosition="right"></i>
                                </label>
                                <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                                    <button type="button" pButton
                                        class="p-button-text p-button-rounded p-button-success" icon="pi pi-refresh"
                                        pTooltip="Refresh prompt values" tooltipPosition="left"
                                        (click)="refreshPromptValues()">
                                    </button>
                                    <button type="button" pButton
                                        class="p-button-text p-button-rounded p-button-warning" icon="pi pi-bolt"
                                        pTooltip="Load values from SQL query" tooltipPosition="left"
                                        (click)="openSqlDialog()">
                                    </button>
                                    <button type="button" pButton class="p-button-text p-button-rounded p-button-info"
                                        icon="pi pi-upload" pTooltip="Upload values from file (CSV/TXT)"
                                        tooltipPosition="left" (click)="fileInput.click()">
                                    </button>
                                    <input type="file" #fileInput accept=".csv,.txt" style="display: none;"
                                        (change)="onPromptFileUpload($event)">
                                    <button type="button" pButton class="p-button-text p-button-rounded p-button-danger"
                                        icon="pi pi-trash" pTooltip="Clear all values" tooltipPosition="left"
                                        (click)="clearPromptValues()"
                                        [disabled]="!promptForm.get('promptValues')?.value?.length">
                                    </button>
                                </div>
                            </div>
                            <p-chips id="promptValues" formControlName="promptValues" [addOnBlur]="true"
                                [addOnTab]="true" [allowDuplicate]="false" [separator]="separator"
                                placeholder="Enter values and press Enter or Comma"
                                (onChipDoubleClick)="onChipDoubleClick($event)"
                                [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptValues')?.invalid && promptForm.get('promptValues')?.touched}">
                                <ng-template let-item pTemplate="item">
                                    <span
                                        [class.editing]="editingChipIndex === promptForm.get('promptValues')?.value?.indexOf(item)"
                                        (dblclick)="onChipDoubleClick({value: item})">
                                        <span
                                            *ngIf="editingChipIndex !== promptForm.get('promptValues')?.value?.indexOf(item)">
                                            {{item}}
                                        </span>
                                        <input
                                            *ngIf="editingChipIndex === promptForm.get('promptValues')?.value?.indexOf(item)"
                                            #chipInput type="text" [value]="item" (keydown.enter)="updateChip($event)"
                                            (keydown.escape)="cancelEdit()" (blur)="updateChip($event)">
                                    </span>
                                </ng-template>
                            </p-chips>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptValues')?.invalid && promptForm.get('promptValues')?.touched">
                                Prompt values are required
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- SQL Query Dialog Component -->
<app-sql-query-dialog [visible]="showSqlDialog" [schemaData]="staticSchemaData"
    [currentSchema]="promptForm.get('schema')?.value?.name" (close)="closeSqlDialog()"
    (execute)="executeSqlQuery($event)">
</app-sql-query-dialog>

<!-- Dropdown Configuration Dialog -->
<app-dropdown-config-dialog [visible]="showDropdownConfigDialog"
    [promptValues]="promptForm.get('promptValues')?.value || []" [currentConfig]="dropdownConfig"
    (close)="showDropdownConfigDialog = false" (save)="onDropdownConfigSaved($event)">
</app-dropdown-config-dialog>

<!-- Multiselect Configuration Dialog -->
<app-multiselect-config-dialog [visible]="showMultiselectConfigDialog"
    [promptValues]="promptForm.get('promptValues')?.value || []" [currentConfig]="multiselectConfig"
    (close)="showMultiselectConfigDialog = false" (save)="onMultiselectConfigSaved($event)">
</app-multiselect-config-dialog>

<!-- Checkbox Configuration Dialog -->
<app-checkbox-config-dialog [visible]="showCheckboxConfigDialog" [currentConfig]="checkboxConfig"
    (close)="showCheckboxConfigDialog = false" (save)="onCheckboxConfigSaved($event)">
</app-checkbox-config-dialog>

<!-- Radio Configuration Dialog -->
<app-radio-config-dialog [visible]="showRadioConfigDialog"
    [promptValues]="promptForm.get('promptValues')?.value || []" [currentConfig]="radioConfig"
    (close)="showRadioConfigDialog = false" (save)="onRadioConfigSaved($event)">
</app-radio-config-dialog>

<!-- Text Configuration Dialog -->
<app-text-config-dialog [visible]="showTextConfigDialog" [currentConfig]="textConfig"
    (close)="showTextConfigDialog = false" (save)="onTextConfigSaved($event)">
</app-text-config-dialog>

<!-- Number Configuration Dialog -->
<app-number-config-dialog [visible]="showNumberConfigDialog" [currentConfig]="numberConfig"
    (close)="showNumberConfigDialog = false" (save)="onNumberConfigSaved($event)">
</app-number-config-dialog>

<!-- Date Configuration Dialog -->
<app-date-config-dialog [visible]="showDateConfigDialog" [currentConfig]="dateConfig"
    (close)="showDateConfigDialog = false" (save)="onDateConfigSaved($event)">
</app-date-config-dialog>

<!-- Date Range Configuration Dialog -->
<app-daterange-config-dialog [visible]="showDateRangeConfigDialog" [currentConfig]="dateRangeConfig"
    (close)="showDateRangeConfigDialog = false" (save)="onDateRangeConfigSaved($event)">
</app-daterange-config-dialog>

<!-- Calendar Configuration Dialog -->
<app-calendar-config-dialog [visible]="showCalendarConfigDialog" [currentConfig]="calendarConfig"
    (close)="showCalendarConfigDialog = false" (save)="onCalendarConfigSaved($event)">
</app-calendar-config-dialog>

<!-- Range Slider Configuration Dialog -->
<app-rangeslider-config-dialog [visible]="showRangeSliderConfigDialog" [currentConfig]="rangeSliderConfig"
    (close)="showRangeSliderConfigDialog = false" (save)="onRangeSliderConfigSaved($event)">
</app-rangeslider-config-dialog>