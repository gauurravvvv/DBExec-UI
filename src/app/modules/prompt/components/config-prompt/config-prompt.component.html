<div class="add-admin-wrapper">
    <div class="add-admin-container">
        <div class="page-header">
            <div class="left-section">
                <button pButton class="p-button-text" routerLink="/app/prompt">
                    <i class="pi pi-arrow-left"></i>
                </button>
                <h2>Configure Prompt</h2>
            </div>
            <div class="action-buttons">
                <button pButton type="button" label="Cancel" class="p-button-outlined p-button-danger"
                    [disabled]="!isFormDirty || isCancelClicked" (click)="onCancel()">
                </button>
                <button pButton class="p-button-outlined" type="submit" label="Save" (click)="onSubmit()"
                    [disabled]="promptForm.invalid || !isFormDirty">
                    <i class="pi pi-save mr-2"></i>
                </button>
            </div>
        </div>
        <form [formGroup]="promptForm" class="admin-form" #formContainer>
            <div class="form-container">
                <div class="form-grid left-column">
                    <div class="form-row">
                        <div class="form-field half-width">
                            <label for="name">Name</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-tag"></i>
                                <input id="name" type="text" pInputText [value]="promptForm.get('name')?.value"
                                    disabled>
                            </span>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-field" *ngIf="showOrganisationDropdown">
                            <label for="organisation">Organisation</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-building"></i>
                                <input id="organisation" type="text" pInputText [value]="selectedOrgName" disabled>
                            </span>
                        </div>
                        <div class="form-field">
                            <label for="database">Database</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-database"></i>
                                <input id="database" type="text" pInputText [value]="selectedDatabaseName" disabled>
                            </span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="tab">Tab</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-box"></i>
                                <input id="tab" type="text" pInputText [value]="selectedTabName" disabled>
                            </span>
                        </div>
                        <div class="form-field">
                            <label for="section">Section</label>
                            <span class="p-input-icon-left">
                                <i class="pi pi-box"></i>
                                <input id="section" type="text" pInputText [value]="selectedSectionName" disabled>
                            </span>
                        </div>
                    </div>
                    <div class="section-header">
                        <h3>
                            <i class="pi pi-database mr-2"></i>
                            Query Configurations
                        </h3>
                    </div>
                    <div class="form-row schema-table-row">
                        <div class="form-field schema-field">
                            <label for="schema">Schema<span class="required">*</span></label>
                            <p-dropdown id="schema" [options]="schemas" formControlName="schema" [filter]="true"
                                filterBy="name" placeholder="Select Schema" [style]="{'width':'100%'}"
                                optionLabel="name"
                                [ngClass]="{'ng-invalid ng-dirty': promptForm.get('schema')?.invalid && promptForm.get('schema')?.touched}">
                            </p-dropdown>
                            <small class="error-message"
                                *ngIf="promptForm.get('schema')?.invalid && promptForm.get('schema')?.touched">
                                Schema is required
                            </small>
                        </div>
                        <div class="form-field">
                            <label for="promptTable">Table(s)<span class="required">*</span></label>
                            <p-multiSelect [options]="getAvailableTables(promptForm.get('schema')?.value)"
                                formControlName="tables" optionLabel="name" optionValue="value" [filter]="true"
                                filterBy="name" [style]="{'width':'100%'}" [panelStyle]="{'width':'100%'}"
                                placeholder="Select Tables" display="chip"
                                [ngClass]="{'ng-invalid ng-dirty': promptForm.get('tables')?.invalid && promptForm.get('tables')?.touched}">
                            </p-multiSelect>
                            <small class="error-message"
                                *ngIf="promptForm.get('tables')?.invalid && promptForm.get('tables')?.touched">
                                At least one table is required
                            </small>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 0">
                        <div class="form-field full-width">
                            <label for="promptColumns">
                                Column(s)<span class="required">*</span>
                                <i class="pi pi-info-circle info-icon"
                                    pTooltip="Select one or more columns to include in your query"
                                    tooltipPosition="right"></i>
                            </label>
                            <p-multiSelect id="promptColumns" [options]="availableColumns" formControlName="columns"
                                optionLabel="displayName" [filter]="true" filterBy="displayName,columnName"
                                [style]="{'width':'100%'}" [panelStyle]="{'width':'100%'}" placeholder="Select Columns"
                                display="chip" [showToggleAll]="true"
                                [ngClass]="{'ng-invalid ng-dirty': promptForm.get('columns')?.invalid && promptForm.get('columns')?.touched}">
                            </p-multiSelect>
                            <small class="error-message"
                                *ngIf="promptForm.get('columns')?.invalid && promptForm.get('columns')?.touched">
                                At least one column is required
                            </small>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 1">
                        <div class="form-field full-width">
                            <label for="promptJoin">
                                Prompt Join Condition<span class="required">*</span>
                                <i class="pi pi-info-circle info-icon"
                                    pTooltip="Define how tables are related. Type alias followed by '.' for suggestions"
                                    tooltipPosition="right"></i>
                            </label>
                            <div class="autocomplete-container">
                                <span class="p-input-icon-left full-width">
                                    <i class="pi pi-link"></i>
                                    <input id="promptJoin" type="text" pInputText formControlName="promptJoin"
                                        (input)="onJoinConditionInput($event)" (keydown)="onJoinKeydown($event)"
                                        (blur)="hideJoinSuggestionsDelayed()" (focus)="onJoinFocus($event)"
                                        placeholder="Example: o.user_id = u.id" autocomplete="off"
                                        [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptJoin')?.invalid && promptForm.get('promptJoin')?.touched}">
                                </span>

                                <!-- Enhanced Autocomplete Dropdown for Join -->
                                <div class="column-suggestions"
                                    *ngIf="showJoinSuggestions && filteredJoinColumns.length > 0">
                                    <div class="suggestions-header">
                                        <span>{{ filteredJoinColumns.length }} column(s) found</span>
                                        <span class="keyboard-hint">↑↓ Navigate • Enter Select • Esc Close</span>
                                    </div>
                                    <div class="suggestions-list">
                                        <div class="suggestion-item"
                                            *ngFor="let column of filteredJoinColumns.slice(0, maxSuggestions); let i = index"
                                            [class.selected]="i === selectedJoinSuggestionIndex"
                                            (mousedown)="selectJoinSuggestion(column)"
                                            (mouseenter)="selectedJoinSuggestionIndex = i">
                                            <i class="pi pi-hashtag column-icon"></i>
                                            <span class="column-name">{{ column.name }}</span>
                                            <span class="column-type">{{ column.type }}</span>
                                        </div>
                                    </div>
                                    <div class="suggestions-footer" *ngIf="filteredJoinColumns.length > maxSuggestions">
                                        <span>Showing {{ maxSuggestions }} of {{ filteredJoinColumns.length }} results.
                                            Type more to filter.</span>
                                    </div>
                                </div>

                                <!-- No Results Message -->
                                <div class="column-suggestions no-results"
                                    *ngIf="showJoinSuggestions && filteredJoinColumns.length === 0 && currentJoinAlias">
                                    <div class="no-results-content">
                                        <i class="pi pi-search"></i>
                                        <span>No columns found for "{{ currentJoinAlias }}"</span>
                                    </div>
                                </div>
                            </div>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptJoin')?.invalid && promptForm.get('promptJoin')?.touched">
                                Join condition is required
                            </small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field full-width">
                            <label for="promptWhere">
                                Prompt Where Condition<span class="required">*</span>
                                <i class="pi pi-info-circle info-icon"
                                    pTooltip="Specify the filter condition. Type alias.column followed by operator"
                                    tooltipPosition="right"></i>
                            </label>
                            <div class="autocomplete-container">
                                <span class="p-input-icon-left full-width">
                                    <i class="pi pi-filter"></i>
                                    <input id="promptWhere" type="text" pInputText formControlName="promptWhere"
                                        (input)="onWhereConditionInput($event)" (keydown)="onWhereKeydown($event)"
                                        (blur)="hideSuggestionsDelayed()" (focus)="onWhereFocus($event)"
                                        [placeholder]="getWhereTemplate()" autocomplete="off"
                                        [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptWhere')?.invalid && promptForm.get('promptWhere')?.touched}">
                                </span>

                                <!-- Enhanced Autocomplete Dropdown -->
                                <div class="column-suggestions" *ngIf="showSuggestions && filteredColumns.length > 0">
                                    <div class="suggestions-header">
                                        <span>{{ filteredColumns.length }} column(s) found</span>
                                        <span class="keyboard-hint">↑↓ Navigate • Enter Select • Esc Close</span>
                                    </div>
                                    <div class="suggestions-list">
                                        <div class="suggestion-item"
                                            *ngFor="let column of filteredColumns.slice(0, maxSuggestions); let i = index"
                                            [class.selected]="i === selectedSuggestionIndex"
                                            (mousedown)="selectSuggestion(column)"
                                            (mouseenter)="selectedSuggestionIndex = i">
                                            <i class="pi pi-hashtag column-icon"></i>
                                            <span class="column-name">{{ column.name }}</span>
                                            <span class="column-type">{{ column.type }}</span>
                                        </div>
                                    </div>
                                    <div class="suggestions-footer" *ngIf="filteredColumns.length > maxSuggestions">
                                        <span>Showing {{ maxSuggestions }} of {{ filteredColumns.length }} results. Type
                                            more to filter.</span>
                                    </div>
                                </div>

                                <!-- No Results Message -->
                                <div class="column-suggestions no-results"
                                    *ngIf="showSuggestions && filteredColumns.length === 0 && currentAlias">
                                    <div class="no-results-content">
                                        <i class="pi pi-search"></i>
                                        <span>No columns found for "{{ currentAlias }}"</span>
                                    </div>
                                </div>
                            </div>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptWhere')?.invalid && promptForm.get('promptWhere')?.touched">
                                Where condition is required
                            </small>
                        </div>
                    </div>

                    <!-- Live SQL Preview Section -->
                    <div class="form-row" *ngIf="promptForm.get('tables')?.value?.length > 0">
                        <div class="form-field full-width">
                            <div class="section-header sql-preview-header">
                                <h3>
                                    <i class="pi pi-code mr-2"></i>
                                    SQL Preview
                                </h3>
                                <button type="button" pButton class="p-button-text p-button-rounded p-button-sm"
                                    icon="pi pi-copy" pTooltip="Copy SQL" tooltipPosition="left"
                                    (click)="copySqlToClipboard()">
                                </button>
                            </div>
                            <div class="sql-preview-container">
                                <pre class="sql-preview-code"><code>{{ generateSqlPreview() }}</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="section-header" *ngIf="showAddPromptValues">
                        <h3>
                            <i class="pi pi-list mr-2"></i>
                            Prompt Configuration
                        </h3>
                    </div>
                    <div class="form-row" *ngIf="showAddPromptValues">
                        <div class="form-field">
                            <div class="label-with-clear"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label for="promptValues" style="margin-bottom: 0;">
                                    Prompt Values<span class="required">*</span>
                                    <i class="pi pi-info-circle info-icon"
                                        pTooltip="Add selectable options. Press Enter or Comma to add each value"
                                        tooltipPosition="right"></i>
                                </label>
                                <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                                    <button type="button" pButton class="p-button-text p-button-rounded p-button-plain"
                                        icon="pi pi-database" pTooltip="Load values from SQL query"
                                        tooltipPosition="left" (click)="openSqlDialog()">
                                    </button>
                                    <label class="upload-label" style="cursor: pointer; margin-bottom: 0;">
                                        <i class="pi pi-upload p-button-text p-button-rounded p-button-plain"
                                            pTooltip="Upload values from file (CSV/TXT). Values can be separated by comma, newline, or pipe"
                                            tooltipPosition="left"></i>
                                        <input type="file" accept=".csv,.txt" style="display: none;"
                                            (change)="onPromptFileUpload($event)">
                                    </label>
                                    <button type="button" pButton
                                        class="p-button-text p-button-rounded p-button-plain clear-all-button"
                                        icon="pi pi-trash" pTooltip="Clear all values" tooltipPosition="left"
                                        (click)="clearPromptValues()"
                                        [disabled]="!promptForm.get('promptValues')?.value?.length">
                                    </button>
                                </div>
                            </div>
                            <p-chips id="promptValues" formControlName="promptValues" [addOnBlur]="true"
                                [addOnTab]="true" [allowDuplicate]="false" [separator]="separator"
                                placeholder="Enter values and press Enter or Comma"
                                (onChipDoubleClick)="onChipDoubleClick($event)"
                                [ngClass]="{'ng-invalid ng-dirty': promptForm.get('promptValues')?.invalid && promptForm.get('promptValues')?.touched}">
                                <ng-template let-item pTemplate="item">
                                    <span
                                        [class.editing]="editingChipIndex === promptForm.get('promptValues')?.value?.indexOf(item)"
                                        (dblclick)="onChipDoubleClick({value: item})">
                                        <span
                                            *ngIf="editingChipIndex !== promptForm.get('promptValues')?.value?.indexOf(item)">
                                            {{item}}
                                        </span>
                                        <input
                                            *ngIf="editingChipIndex === promptForm.get('promptValues')?.value?.indexOf(item)"
                                            #chipInput type="text" [value]="item" (keydown.enter)="updateChip($event)"
                                            (keydown.escape)="cancelEdit()" (blur)="updateChip($event)">
                                    </span>
                                </ng-template>
                            </p-chips>
                            <small class="error-message"
                                *ngIf="promptForm.get('promptValues')?.invalid && promptForm.get('promptValues')?.touched">
                                Prompt values are required
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- SQL Query Dialog Component -->
<app-sql-query-dialog [visible]="showSqlDialog" [schemaData]="staticSchemaData"
    [currentSchema]="promptForm.get('schema')?.value?.name" (close)="closeSqlDialog()"
    (execute)="executeSqlQuery($event)">
</app-sql-query-dialog>