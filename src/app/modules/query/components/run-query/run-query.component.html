<div class="super-admin-wrapper" [class.fullscreen-mode]="isFullscreen">
  <div class="super-admin-container">
    <!-- Filter Container -->
    <div class="filter-container" *ngIf="showOrganisationDropdown">
      <div class="dropdowns-wrapper">
        <!-- Organisation Dropdown -->
        <div class="dropdown-field">
          <span class="p-float-label">
            <p-dropdown
              [options]="organisations"
              [(ngModel)]="selectedOrg"
              optionLabel="name"
              [filter]="true"
              filterBy="name"
              [style]="{ width: '100%' }"
              [panelStyle]="{ width: '100%' }"
              (onChange)="onOrgChange($event)"
              inputId="org-dropdown"
            >
            </p-dropdown>
            <label for="org-dropdown">Organisation</label>
          </span>
        </div>
      </div>
    </div>

    <!-- Existing Content -->
    <div class="run-query-container">
      <!-- Main horizontal splitter -->
      <p-splitter
        [style]="{ height: '100%', width: '100%' }"
        [panelSizes]="horizontalSplitterSizes"
        [minSizes]="[10, 60]"
        layout="horizontal"
        styleClass="main-horizontal-splitter"
        (onResizeEnd)="onHorizontalSplitterResize($event)"
      >
        <!-- Left Panel - Schema Browser -->
        <ng-template pTemplate>
          <div class="schema-panel">
            <div class="panel-header">
              <h3>Databases</h3>
            </div>
            <div class="panel-content">
              <!-- Loading indicator -->
              <div class="loading-container" *ngIf="isDatabasesLoading">
                <i class="pi pi-spin pi-spinner loading-icon"></i>
                <span class="loading-text">Loading databases...</span>
              </div>

              <!-- Database Tree -->
              <p-tree
                [value]="databaseTree"
                [filter]="true"
                filterMode="lenient"
                filterPlaceholder="Search databases..."
                styleClass="database-tree"
                (onNodeExpand)="onDatabaseNodeExpand($event)"
              >
                <ng-template let-node pTemplate="default">
                  <div
                    class="tree-node-content"
                    [class]="'level-' + node.data?.level"
                    [attr.data-type]="node.data?.type"
                    (contextmenu)="onDatabaseNodeRightClick($event, node)"
                  >
                    <div class="node-main">
                      <i
                        class="node-icon"
                        [class]="getNodeIcon(node.data?.type)"
                      ></i>
                      <span class="node-label">{{ node.label }}</span>
                      <span class="node-type" *ngIf="node.data?.type">{{
                        node.data.type
                      }}</span>
                      <i
                        class="pi pi-spin pi-spinner loading-indicator"
                        *ngIf="node.data?.loading"
                      ></i>
                    </div>
                  </div>
                </ng-template>
              </p-tree>

              <!-- Empty state -->
              <div
                class="empty-state"
                *ngIf="!isDatabasesLoading && databases.length === 0"
              >
                <i class="pi pi-database empty-icon"></i>
                <p>No databases available</p>
              </div>
            </div>
          </div>
        </ng-template>

        <!-- Right Panel - Editor and Results -->
        <ng-template pTemplate>
          <!-- Vertical splitter for editor and results -->
          <p-splitter
            [style]="{ height: '100%', width: '100%' }"
            [panelSizes]="verticalSplitterSizes"
            [minSizes]="[30, 15]"
            layout="vertical"
            styleClass="editor-results-splitter"
            (onResizeEnd)="onVerticalSplitterResize($event)"
          >
            <!-- Top Panel - SQL Editor -->
            <ng-template pTemplate>
              <div class="editor-panel">
                <div class="editor-tabs">
                  <div class="tabs-container">
                    <div
                      *ngFor="let tab of tabs; let i = index"
                      class="editor-tab"
                      [class.active]="tab.id === activeTabId"
                      [attr.data-tab-id]="tab.id"
                      [pTooltip]="tab.database?.name"
                      tooltipPosition="top"
                      [showDelay]="0"
                      [hideDelay]="0"
                      (click)="!tab.isEditing && switchTab(tab.id)"
                      (dblclick)="startEditingTab(tab, $event)"
                      (contextmenu)="onTabRightClick($event, tab, i)"
                    >
                      <ng-container *ngIf="!tab.isEditing">
                        <i
                          class="pi pi-bookmark-fill tab-pin-icon"
                          *ngIf="tab.isPinned"
                        ></i>
                        <span class="tab-title">{{
                          getQueryNumberFromTitle(tab.title)
                        }}</span>
                      </ng-container>
                      <ng-container *ngIf="tab.isEditing">
                        <input
                          #tabInput
                          type="text"
                          class="tab-title-input"
                          [value]="getQueryNumberFromTitle(tab.title)"
                          [attr.data-tab-id]="tab.id"
                          (blur)="finishEditingTab(tab, tabInput.value)"
                          (keydown)="onTabInputKeydown($event, tab, tabInput)"
                          (click)="$event.stopPropagation()"
                        />
                      </ng-container>
                      <i
                        class="pi pi-times tab-close"
                        *ngIf="tabs.length > 1 && !tab.isEditing"
                        (click)="closeTab(tab.id, $event)"
                      ></i>
                    </div>
                  </div>
                  <div class="editor-actions">
                    <button
                      pButton
                      pRipple
                      type="button"
                      icon="pi pi-plus"
                      class="p-button-text p-button-rounded add-btn"
                      [disabled]="isMaxScriptsReached"
                      (mouseenter)="showDatabaseMenu($event)"
                      (mouseleave)="hideDatabaseMenuDelayed()"
                      #addBtn
                    ></button>
                    <button
                      pButton
                      pRipple
                      type="button"
                      icon="pi pi-align-left"
                      class="p-button-text p-button-rounded format-btn"
                      [disabled]="tabs.length === 0"
                      (click)="formatSQL()"
                    ></button>
                    <button
                      pButton
                      pRipple
                      type="button"
                      icon="pi pi-play"
                      class="p-button-text p-button-rounded run-btn"
                      [class.executing]="isExecuting"
                      (click)="executeQuery()"
                      [disabled]="isExecuting || tabs.length === 0"
                    ></button>
                    <button
                      pButton
                      pRipple
                      type="button"
                      icon="pi pi-save"
                      class="p-button-text p-button-rounded save-btn"
                      [disabled]="tabs.length === 0"
                      (mouseenter)="tabs.length > 0 && showSaveMenu($event)"
                      (mouseleave)="tabs.length > 0 && hideSaveMenuDelayed()"
                      #saveBtn
                    ></button>
                    <button
                      pButton
                      pRipple
                      type="button"
                      [icon]="getAutoSaveIconClass()"
                      class="p-button-text p-button-rounded auto-save-btn"
                      [class.enabled]="isAutoSaveEnabled"
                      [class.completed]="autoSaveStatus === 'completed'"
                      [disabled]="tabs.length === 0"
                      (mouseenter)="tabs.length > 0 && showAutoSaveMenu($event)"
                      (mouseleave)="
                        tabs.length > 0 && hideAutoSaveMenuDelayed()
                      "
                      #autoSaveBtn
                    ></button>
                    <button
                      pButton
                      pRipple
                      type="button"
                      [icon]="
                        isFullscreen
                          ? 'pi pi-window-minimize'
                          : 'pi pi-window-maximize'
                      "
                      class="p-button-text p-button-rounded fullscreen-btn"
                      (click)="toggleFullscreen()"
                    ></button>
                  </div>
                </div>
                <div class="panel-content">
                  <div
                    #monacoEditor
                    class="sql-editor-monaco"
                    *ngIf="tabs.length > 0"
                  ></div>
                  <div class="no-tabs-message" *ngIf="tabs.length === 0">
                    <i class="pi pi-database"></i>
                    <h3>No Query Tab Open</h3>
                    <p>Select a database to run query</p>
                    <p class="hint">
                      Hover over the <i class="pi pi-plus"></i> button above and
                      select a database to get started
                    </p>
                  </div>
                </div>
              </div>
            </ng-template>

            <!-- Bottom Panel - Results -->
            <ng-template pTemplate>
              <div class="results-panel">
                <div class="panel-header">
                  <div class="header-left">
                    <i class="pi pi-table"></i>
                    <span>Query Results</span>
                    <div class="results-info" *ngIf="queryResults.length > 0">
                      <span class="result-count"
                        >{{ queryResults.length }} rows</span
                      >
                      <span class="execution-time" *ngIf="executionTime"
                        >{{ executionTime }}ms</span
                      >
                    </div>
                  </div>
                  <div class="view-toggle">
                    <button
                      pButton
                      [class.active]="viewMode === 'table'"
                      class="p-button-text p-button-rounded toggle-btn"
                      (click)="viewMode = 'table'"
                    >
                      <i class="pi pi-table"></i>
                      <span>Table</span>
                    </button>
                    <button
                      pButton
                      [class.active]="viewMode === 'analytics'"
                      class="p-button-text p-button-rounded toggle-btn"
                      (click)="viewMode = 'analytics'"
                    >
                      <i class="pi pi-chart-line"></i>
                      <span>Analytics</span>
                    </button>
                  </div>
                </div>
                <div class="panel-content">
                  <!-- Table View -->
                  <div class="table-view" *ngIf="viewMode === 'table'">
                    <div class="custom-table-container">
                      <!-- Table Controls -->
                      <div
                        class="table-controls"
                        *ngIf="queryResults.length > 0"
                      >
                        <div class="table-info">
                          <span class="result-count"
                            >{{ getDisplayedRowCount() }} of
                            {{ queryResults.length }} rows</span
                          >
                          <span class="column-count"
                            >{{ resultColumns.length }} columns</span
                          >
                        </div>
                        <div class="table-actions">
                          <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select
                              [(ngModel)]="tableRowsPerPage"
                              (change)="onRowsPerPageChange()"
                            >
                              <option [value]="10">10</option>
                              <option [value]="25">25</option>
                              <option [value]="50">50</option>
                              <option [value]="100">100</option>
                              <option [value]="200">200</option>
                              <option [value]="999999">All</option>
                            </select>
                          </div>
                          <button
                            class="table-action-btn"
                            (click)="exportToCSV()"
                            title="Export to CSV"
                          >
                            <i class="pi pi-download"></i>
                          </button>
                        </div>
                      </div>

                      <!-- Custom Table -->
                      <div
                        class="table-wrapper"
                        *ngIf="queryResults.length > 0"
                      >
                        <div
                          class="table-scroll-container"
                          #tableContainer
                          tabindex="0"
                          role="region"
                          aria-label="Query results table"
                          (mouseenter)="onTableMouseEnter()"
                          (mouseleave)="onTableMouseLeave()"
                          (keydown)="onTableKeydown($event)"
                        >
                          <!-- Fixed Table Header -->
                          <div class="table-header-wrapper">
                            <table class="table-header-table">
                              <thead>
                                <tr>
                                  <th
                                    *ngFor="
                                      let col of resultColumns;
                                      trackBy: trackByColumn
                                    "
                                    class="table-header-cell"
                                    [class.sortable]="true"
                                    (click)="sortByColumn(col)"
                                  >
                                    <div class="header-content">
                                      <span class="column-name">{{ col }}</span>
                                      <i
                                        class="sort-icon pi"
                                        [ngClass]="getSortIcon(col)"
                                        *ngIf="getSortIcon(col)"
                                      ></i>
                                    </div>
                                  </th>
                                </tr>
                              </thead>
                            </table>
                          </div>

                          <!-- Scrollable Table Body -->
                          <div class="table-body-wrapper">
                            <table class="table-body-table">
                              <tbody class="table-body">
                                <tr
                                  *ngFor="
                                    let row of getPaginatedData();
                                    trackBy: trackByRow;
                                    let i = index
                                  "
                                  class="table-row"
                                  [class.even]="i % 2 === 0"
                                  [class.odd]="i % 2 !== 0"
                                >
                                  <td
                                    *ngFor="
                                      let col of resultColumns;
                                      trackBy: trackByColumn
                                    "
                                    class="table-cell"
                                    [title]="getCellValue(row, col)"
                                  >
                                    <div
                                      class="cell-content"
                                      [class.null-value]="
                                        isNullValue(getCellValue(row, col))
                                      "
                                      [class.number-value]="
                                        isNumberValue(getCellValue(row, col))
                                      "
                                      [class.boolean-value]="
                                        isBooleanValue(getCellValue(row, col))
                                      "
                                      [class.date-value]="
                                        isDateValue(getCellValue(row, col))
                                      "
                                    >
                                      <span
                                        *ngIf="
                                          isNullValue(getCellValue(row, col))
                                        "
                                        class="null-text"
                                        >NULL</span
                                      >
                                      <span
                                        *ngIf="
                                          !isNullValue(getCellValue(row, col))
                                        "
                                        >{{
                                          formatCellValue(getCellValue(row, col))
                                        }}</span
                                      >
                                    </div>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>

                      <!-- Pagination -->
                      <div class="table-pagination" *ngIf="getTotalPages() > 1">
                        <div class="pagination-info">
                          <span
                            >Page {{ currentPage + 1 }} of
                            {{ getTotalPages() }}</span
                          >
                        </div>
                        <div class="pagination-controls">
                          <button
                            class="pagination-btn"
                            [disabled]="currentPage === 0"
                            (click)="goToFirstPage()"
                            title="First page"
                          >
                            <i class="pi pi-angle-double-left"></i>
                          </button>
                          <button
                            class="pagination-btn"
                            [disabled]="currentPage === 0"
                            (click)="goToPreviousPage()"
                            title="Previous page"
                          >
                            <i class="pi pi-angle-left"></i>
                          </button>

                          <div class="page-numbers">
                            <button
                              *ngFor="let page of getVisiblePageNumbers()"
                              class="page-number-btn"
                              [class.active]="page === currentPage"
                              (click)="goToPage(page)"
                            >
                              {{ page + 1 }}
                            </button>
                          </div>

                          <button
                            class="pagination-btn"
                            [disabled]="currentPage >= getTotalPages() - 1"
                            (click)="goToNextPage()"
                            title="Next page"
                          >
                            <i class="pi pi-angle-right"></i>
                          </button>
                          <button
                            class="pagination-btn"
                            [disabled]="currentPage >= getTotalPages() - 1"
                            (click)="goToLastPage()"
                            title="Last page"
                          >
                            <i class="pi pi-angle-double-right"></i>
                          </button>
                        </div>
                      </div>

                      <!-- Empty State -->
                      <div
                        class="empty-state"
                        *ngIf="queryResults.length === 0"
                      >
                        <i class="pi pi-inbox empty-icon"></i>
                        <h3>No results to display</h3>
                        <p>Execute a query to see results</p>
                      </div>
                    </div>
                  </div>

                  <!-- Analytics View -->
                  <div class="analytics-view" *ngIf="viewMode === 'analytics'">
                    <!-- Simplified Chart Configuration -->
                    <div class="chart-configuration-simple" [formGroup]="chartForm">
                      <!-- Chart Type Selection - Single Row -->
                      <div class="chart-type-row">
                        <div class="chart-type-field">
                          <label class="field-label">Chart Type <span class="required-marker">*</span></label>
                          <p-dropdown
                            [options]="chartTypes"
                            [formControlName]="'chartType'"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Choose a chart type..."
                            [style]="{ width: '100%' }"
                            [panelStyle]="{ width: '100%' }"
                            [filter]="true"
                            filterBy="label"
                            (onChange)="onChartTypeDropdownChange($event)"
                          >
                            <ng-template let-chartType pTemplate="item">
                              <div class="chart-option">
                                <i [class]="chartType.icon" class="chart-icon"></i>
                                <div class="chart-info">
                                  <span class="chart-name">{{ chartType.label }}</span>
                                  <span class="chart-desc">{{ chartType.description }}</span>
                                </div>
                              </div>
                            </ng-template>
                            <ng-template let-chartType pTemplate="selectedItem">
                              <div class="chart-selected">
                                <i [class]="chartType.icon" class="chart-icon"></i>
                                <span>{{ chartType.label }}</span>
                              </div>
                            </ng-template>
                          </p-dropdown>
                        </div>
                      </div>

                      <!-- Data Configuration Row -->
                      <div class="data-config-row" *ngIf="selectedChartType">
                        <div class="config-fields">
                          <!-- Dynamic Input Fields -->
                          <div 
                            *ngFor="let input of selectedChartType.inputs" 
                            class="config-field"
                          >
                            <!-- Single Selection -->
                            <div *ngIf="!input.multiple" class="field-container">
                              <label class="field-label">{{ input.label }}<span *ngIf="input.required" class="required-marker"> *</span></label>
                              <p-dropdown
                                [options]="getOptionsForInput(input)"
                                [formControlName]="input.name"
                                optionLabel="label"
                                optionValue="value"
                                [filter]="true"
                                filterBy="label"
                                [style]="{ width: '100%' }"
                                [showClear]="!input.required"
                                [placeholder]="'Select ' + input.label.toLowerCase()"
                              >
                                <ng-template let-column pTemplate="item">
                                  <div class="column-option">
                                    <span class="column-name">{{ column.label }}</span>
                                    <span class="column-type" [ngClass]="'type-' + column.type">{{ column.type }}</span>
                                  </div>
                                </ng-template>
                              </p-dropdown>
                            </div>

                            <!-- Multiple Selection -->
                            <div *ngIf="input.multiple" class="field-container">
                              <label class="field-label">{{ input.label }}<span *ngIf="input.required" class="required-marker"> *</span></label>
                              <p-multiSelect
                                [options]="getOptionsForInput(input)"
                                [ngModel]="getFormArrayValue(input.name)"
                                (ngModelChange)="updateFormArray(input.name, $event)"
                                optionLabel="label"
                                optionValue="value"
                                [filter]="true"
                                filterBy="label"
                                [style]="{ width: '100%' }"
                                [placeholder]="'Select ' + input.label.toLowerCase()"
                                [showToggleAll]="false"
                                [maxSelectedLabels]="2"
                              >
                                <ng-template let-column pTemplate="item">
                                  <div class="column-option">
                                    <span class="column-name">{{ column.label }}</span>
                                    <span class="column-type" [ngClass]="'type-' + column.type">{{ column.type }}</span>
                                  </div>
                                </ng-template>
                              </p-multiSelect>
                            </div>
                          </div>
                        </div>

                        <!-- Generate Button -->
                        <div class="generate-button">
                          <button
                            pButton
                            class="p-button-primary generate-chart-btn"
                            icon="pi pi-chart-line"
                            label="Generate Chart"
                            [loading]="isGeneratingChart"
                            [disabled]="!canGenerateChart()"
                            (click)="generateChart()"
                          ></button>
                        </div>
                      </div>
                    </div>

                    <!-- Chart Display Section -->
                    <div class="chart-container" *ngIf="showChart && ngxChartData.length > 0">
                      <!-- Bar Charts -->
                      <ngx-charts-bar-vertical
                        *ngIf="selectedChartType?.value === 'bar-vertical'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                        [showDataLabel]="showDataLabel"
                      >
                      </ngx-charts-bar-vertical>

                      <ngx-charts-bar-horizontal
                        *ngIf="selectedChartType?.value === 'bar-horizontal'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="yAxisLabel"
                        [yAxisLabel]="xAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                        [showDataLabel]="showDataLabel"
                      >
                      </ngx-charts-bar-horizontal>

                      <ngx-charts-bar-vertical-2d
                        *ngIf="selectedChartType?.value === 'bar-vertical-grouped'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                        [showDataLabel]="showDataLabel"
                      >
                      </ngx-charts-bar-vertical-2d>

                      <!-- Line & Area Charts -->
                      <ngx-charts-line-chart
                        *ngIf="selectedChartType?.value === 'line-chart'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                      >
                      </ngx-charts-line-chart>

                      <ngx-charts-area-chart
                        *ngIf="selectedChartType?.value === 'area-chart'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                      >
                      </ngx-charts-area-chart>

                      <!-- Pie Charts -->
                      <ngx-charts-pie-chart
                        *ngIf="selectedChartType?.value === 'pie-chart'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [legend]="showLegend"
                        [animations]="animations"
                        [labels]="true"
                        [doughnut]="false"
                      >
                      </ngx-charts-pie-chart>

                      <ngx-charts-advanced-pie-chart
                        *ngIf="selectedChartType?.value === 'pie-chart-advanced'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                      >
                      </ngx-charts-advanced-pie-chart>

                      <ngx-charts-pie-grid
                        *ngIf="selectedChartType?.value === 'pie-chart-grid'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                      >
                      </ngx-charts-pie-grid>

                      <!-- Other Charts -->
                      <ngx-charts-bubble-chart
                        *ngIf="selectedChartType?.value === 'bubble-chart'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                        [showGridLines]="showGridLines"
                        [roundDomains]="roundDomains"
                      >
                      </ngx-charts-bubble-chart>

                      <ngx-charts-heat-map
                        *ngIf="selectedChartType?.value === 'heat-map'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [xAxis]="showXAxis"
                        [yAxis]="showYAxis"
                        [legend]="showLegend"
                        [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel"
                        [xAxisLabel]="xAxisLabel"
                        [yAxisLabel]="yAxisLabel"
                        [animations]="animations"
                      >
                      </ngx-charts-heat-map>

                      <ngx-charts-tree-map
                        *ngIf="selectedChartType?.value === 'tree-map'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                      >
                      </ngx-charts-tree-map>

                      <ngx-charts-number-card
                        *ngIf="selectedChartType?.value === 'number-card'"
                        [results]="ngxChartData"
                        [view]="ngxChartView"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                      >
                      </ngx-charts-number-card>

                      <ngx-charts-gauge
                        *ngIf="selectedChartType?.value === 'gauge'"
                        [results]="ngxChartData"
                        [view]="[400, 400]"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                        [legend]="false"
                        [min]="0"
                        [max]="100"
                        [angleSpan]="240"
                        [startAngle]="-120"
                        [units]="'%'"
                        [showAxis]="true"
                      >
                      </ngx-charts-gauge>

                      <ngx-charts-linear-gauge
                        *ngIf="selectedChartType?.value === 'linear-gauge'"
                        [results]="ngxChartData"
                        [view]="[700, 100]"
                        [scheme]="ngxChartScheme"
                        [animations]="animations"
                        [min]="0"
                        [max]="100"
                        [units]="'units'"
                      >
                      </ngx-charts-linear-gauge>
                    </div>
                    <!-- Empty States -->
                    <div class="empty-chart" *ngIf="!queryResults.length && !selectedChartType">
                      <i class="pi pi-chart-line"></i>
                      <p>No data available to visualize</p>
                      <small>Execute a query to see results</small>
                    </div>
                    
                    <div class="empty-chart" *ngIf="queryResults.length && selectedChartType && !showChart">
                      <i class="pi pi-info-circle"></i>
                      <p>Configure your chart</p>
                      <small>Select the required fields and click Generate Chart</small>
                    </div>

                    <div class="chart-loading" *ngIf="isGeneratingChart">
                      <i class="pi pi-spin pi-spinner"></i>
                      <span>Generating chart...</span>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-splitter>
        </ng-template>
      </p-splitter>
    </div>
  </div>
</div>

<!-- Tab Context Menu -->
<div
  class="tab-context-menu"
  *ngIf="showTabContextMenu"
  [style.left.px]="contextMenuPosition.x"
  [style.top.px]="contextMenuPosition.y"
  (click)="$event.stopPropagation()"
>
  <div
    class="context-menu-item"
    (click)="
      selectedTabForContext && closeTabFromContext(selectedTabForContext.id)
    "
  >
    <i class="pi pi-times"></i>
    <span>Close This Tab</span>
  </div>
  <div
    class="context-menu-item"
    (click)="selectedTabForContext && closeOtherTabs(selectedTabForContext.id)"
    [class.disabled]="tabs.length <= 1"
  >
    <i class="pi pi-minus-circle"></i>
    <span>Close Others</span>
  </div>
  <div
    class="context-menu-item"
    (click)="closeTabsToRight(selectedTabIndexForContext)"
    [class.disabled]="!hasTabsToRight(selectedTabIndexForContext)"
  >
    <i class="pi pi-angle-right"></i>
    <span>Close All to Right</span>
  </div>
  <div
    class="context-menu-item"
    (click)="closeTabsToLeft(selectedTabIndexForContext)"
    [class.disabled]="!hasTabsToLeft(selectedTabIndexForContext)"
  >
    <i class="pi pi-angle-left"></i>
    <span>Close All to Left</span>
  </div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item" (click)="renameTabFromContextMenu()">
    <i class="pi pi-pencil"></i>
    <span>Rename Tab</span>
  </div>
  <div class="context-menu-item" (click)="togglePinTabFromContextMenu()">
    <i
      class="pi"
      [class.pi-bookmark]="!selectedTabForContext?.isPinned"
      [class.pi-bookmark-fill]="selectedTabForContext?.isPinned"
    ></i>
    <span>{{ selectedTabForContext?.isPinned ? 'Unpin Tab' : 'Pin Tab' }}</span>
  </div>
  <div class="context-menu-separator"></div>
  <div
    class="context-menu-item"
    (click)="closeAllTabs()"
    [class.disabled]="tabs.length <= 1"
  >
    <i class="pi pi-times-circle"></i>
    <span>Close All Tabs</span>
  </div>
</div>

<!-- Backdrop to close context menu -->
<div
  class="context-menu-backdrop"
  *ngIf="showTabContextMenu"
  (click)="hideTabContextMenu()"
></div>

<!-- Database Menu -->
<p-menu
  #databaseMenu
  [model]="databaseMenuItems"
  [popup]="true"
  styleClass="database-menu"
  (mouseenter)="cancelMenuHide('database')"
  (mouseleave)="hideMenuDelayed('database')"
></p-menu>

<!-- Save Menu -->
<p-menu
  #saveMenu
  [model]="saveMenuItems"
  [popup]="true"
  styleClass="database-menu"
  (mouseenter)="cancelMenuHide('save')"
  (mouseleave)="hideMenuDelayed('save')"
></p-menu>

<!-- Auto Save Menu -->
<p-menu
  #autoSaveMenu
  [model]="autoSaveMenuItems"
  [popup]="true"
  styleClass="database-menu"
  (mouseenter)="cancelMenuHide('autoSave')"
  (mouseleave)="hideMenuDelayed('autoSave')"
></p-menu>

<!-- Database Context Menu -->
<div
  class="database-context-menu"
  *ngIf="showDatabaseContextMenu"
  [style.left.px]="databaseContextMenuPosition.x"
  [style.top.px]="databaseContextMenuPosition.y"
  (click)="$event.stopPropagation()"
>
  <div class="context-menu-item" (click)="addNewScriptFromContextMenu()">
    <i class="pi pi-plus"></i>
    <span>New Script</span>
  </div>
  <div class="context-menu-item" (click)="refreshDatabaseFromContextMenu()">
    <i class="pi pi-refresh"></i>
    <span>Refresh</span>
  </div>
</div>

<!-- Backdrop to close database context menu -->
<div
  class="context-menu-backdrop"
  *ngIf="showDatabaseContextMenu"
  (click)="hideDatabaseContextMenu()"
></div>

<!-- Duplicate Name Confirmation Dialog -->
<div class="confirmation-popup" *ngIf="showDuplicateConfirm">
  <div class="popup-content">
    <h3>Duplicacy Found</h3>
    <p>Script name already exists.</p>
    <div class="popup-actions">
      <button class="btn-cancel" (click)="cancelDuplicate()">OK</button>
    </div>
  </div>
</div>
