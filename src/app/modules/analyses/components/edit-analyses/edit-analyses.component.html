<div class="query-editor-wrapper">
    <!-- Header Toolbar -->
    <div class="query-toolbar">
        <div class="toolbar-left">
            <div class="left-section">
                <button pButton class="p-button-text" (click)="goBack()">
                    <i class="pi pi-arrow-left"></i>
                </button>
                <h3 class="toolbar-title">Edit Analysis</h3>
            </div>
        </div>
        <div class="toolbar-right">
            <button pButton class="p-button-text btn-primary" title="Save Analysis" (click)="saveAnalysis()"
                [disabled]="!canSave">
                <i class="pi pi-save"></i>
            </button>
        </div>
    </div>

    <!-- Sub Header with Toggle Buttons -->
    <div class="sub-header">
        <button pButton class="p-button-text btn-primary field-btn" [class.active]="isFieldsPanelOpen"
            (click)="toggleFieldsPanel()" title="Toggle Fields Pane">
            <i class="pi pi-database"></i>
        </button>
        <button pButton class="p-button-text btn-primary visual-btn" [class.active]="isVisualsPanelOpen"
            (click)="toggleVisualsPanel()" title="Toggle Visuals Pane">
            <i class="pi pi-chart-bar"></i>
        </button>
        <div class="analysis-name" style="margin-left: 16px; display: flex; align-items: center; gap: 8px;">
            <span style="font-weight: 500;">{{ analysisDetails?.name }}</span>
        </div>
    </div>

    <!-- Main Content Area with Sidebar and Center -->
    <div class="main-content">

        <!-- Left Sidebar - Fields Panel -->
        <div class="database-sidebar" [class.collapsed]="!isFieldsPanelOpen">
            <div class="sidebar-content">
                <div class="sidebar-header-info">
                    <div class="dataset-label">Dataset</div>
                </div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-content-inner">
                    <!-- Dataset Name Section -->
                    <div class="dataset-name-section">
                        <div class="dataset-name-divider">
                            <span class="dataset-name-text">{{ datasetDetails?.name }}</span>
                        </div>
                    </div>

                    <!-- Fields List -->
                    <div class="fields-list" [class.selection-mode]="activeAxisSelection">
                        <div class="field-card" *ngFor="let field of datasetDetails?.datasetFields"
                            [class.custom-field]="field.type === 2" [class.selectable]="activeAxisSelection !== null"
                            (click)="onFieldClick(field)">
                            <div class="field-icon">
                                <i class="pi pi-bars"></i>
                            </div>
                            <div class="field-info">
                                <div class="field-name">{{ field.columnToView }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Left Sidebar 2 - Visuals Panel -->
        <div class="visuals-sidebar" [class.collapsed]="!isVisualsPanelOpen">
            <div class="sidebar-content">
                <div class="sidebar-header-info">
                    <div class="dataset-label">
                        {{ focusedVisualId && !focusedVisual?.chartType ? 'Select Chart Type' :
                        focusedVisualId && focusedVisual?.chartType ? 'Data Mapping' : 'Visuals' }}
                    </div>
                </div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-content-inner">
                    <!-- Add Visual Button (always visible) -->
                    <div class="add-visual-section">
                        <button pButton label="Add Visual" icon="pi pi-plus" class="p-button-outlined add-visual-button"
                            (click)="addVisual()"></button>
                    </div>

                    <!-- Chart Type Grid (when visual is focused but no chart type selected) -->
                    <div class="chart-type-section" *ngIf="focusedVisualId && !focusedVisual?.chartType">
                        <div class="chart-type-hint">
                            <i class="pi pi-info-circle"></i>
                            <span>Select a chart type for this visual</span>
                        </div>
                        <!-- Search Input for Charts -->
                        <div class="chart-search-wrapper">
                            <span class="p-input-icon-left" style="width: 100%;">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText placeholder="Search charts..."
                                    [(ngModel)]="chartSearchQuery" style="width: 100%;" />
                            </span>
                        </div>
                        <div class="chart-categories">
                            <div class="chart-category-section" *ngFor="let category of getChartCategories()">
                                <div class="category-label">{{ category }}</div>
                                <div class="chart-type-grid">
                                    <div class="chart-type-card" *ngFor="let chartType of getChartsByCategory(category)"
                                        [class.selected]="focusedVisual?.chartType === chartType.id"
                                        (click)="setVisualChartType(chartType)" [pTooltip]="chartType.description"
                                        tooltipPosition="bottom">
                                        <div class="chart-icon" [class.rotate]="chartType.rotate">
                                            <i [class]="chartType.icon"></i>
                                        </div>
                                        <div class="chart-name">{{ chartType.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Mapping Section (when chart type is already selected) -->
                    <div class="chart-type-section" *ngIf="focusedVisualId && focusedVisual?.chartType">
                        <div class="section-divider"></div>
                        <div class="axis-selection-title">Data Mapping</div>
                        <div class="axis-hint" *ngIf="activeAxisSelection">
                            <i class="pi pi-arrow-left"></i>
                            <span>Click a field from the left panel</span>
                        </div>

                        <!-- Heat Map: Row, Column, Value (3 fields) -->
                        <ng-container *ngIf="isHeatMapChartType(focusedVisual.chartType)">
                            <!-- Row Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'x'"
                                [class.has-value]="focusedVisual.xAxisColumn" (click)="startAxisSelection('x')">
                                <div class="axis-label">Row</div>
                                <div class="axis-value" *ngIf="focusedVisual.xAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.xAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('x', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.xAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Column Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'y'"
                                [class.has-value]="focusedVisual.yAxisColumn" (click)="startAxisSelection('y')">
                                <div class="axis-label">Column</div>
                                <div class="axis-value" *ngIf="focusedVisual.yAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.yAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('y', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.yAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Value Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'z'"
                                [class.has-value]="focusedVisual.zAxisColumn" (click)="startAxisSelection('z')">
                                <div class="axis-label">Value</div>
                                <div class="axis-value" *ngIf="focusedVisual.zAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.zAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('z', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.zAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Bubble Chart: X-Axis, Y-Axis, Size (3 fields) -->
                        <ng-container *ngIf="isBubbleChartType(focusedVisual.chartType)">
                            <!-- X-Axis Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'x'"
                                [class.has-value]="focusedVisual.xAxisColumn" (click)="startAxisSelection('x')">
                                <div class="axis-label">X-Axis</div>
                                <div class="axis-value" *ngIf="focusedVisual.xAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.xAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('x', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.xAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Y-Axis Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'y'"
                                [class.has-value]="focusedVisual.yAxisColumn" (click)="startAxisSelection('y')">
                                <div class="axis-label">Y-Axis</div>
                                <div class="axis-value" *ngIf="focusedVisual.yAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.yAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('y', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.yAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Size Slot (optional for bubble) -->
                            <div class="axis-slot optional" [class.active]="activeAxisSelection === 'z'"
                                [class.has-value]="focusedVisual.zAxisColumn" (click)="startAxisSelection('z')">
                                <div class="axis-label">Size (optional)</div>
                                <div class="axis-value" *ngIf="focusedVisual.zAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.zAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('z', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.zAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Axis charts: X-Axis, Y-Axis (bar, line, area) -->
                        <ng-container
                            *ngIf="hasAxisLabels(focusedVisual.chartType) && !isHeatMapChartType(focusedVisual.chartType) && !isBubbleChartType(focusedVisual.chartType)">
                            <!-- X-Axis Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'x'"
                                [class.has-value]="focusedVisual.xAxisColumn" (click)="startAxisSelection('x')">
                                <div class="axis-label">X-Axis</div>
                                <div class="axis-value" *ngIf="focusedVisual.xAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.xAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('x', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.xAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Y-Axis Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'y'"
                                [class.has-value]="focusedVisual.yAxisColumn" (click)="startAxisSelection('y')">
                                <div class="axis-label">Y-Axis</div>
                                <div class="axis-value" *ngIf="focusedVisual.yAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.yAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('y', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.yAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Non-axis charts: Category, Value (pie, gauge, card, tree-map) -->
                        <ng-container
                            *ngIf="!hasAxisLabels(focusedVisual.chartType) && !isBubbleChartType(focusedVisual.chartType)">
                            <!-- Category Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'x'"
                                [class.has-value]="focusedVisual.xAxisColumn" (click)="startAxisSelection('x')">
                                <div class="axis-label">Category</div>
                                <div class="axis-value" *ngIf="focusedVisual.xAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.xAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('x', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.xAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                            <!-- Value Slot -->
                            <div class="axis-slot" [class.active]="activeAxisSelection === 'y'"
                                [class.has-value]="focusedVisual.yAxisColumn" (click)="startAxisSelection('y')">
                                <div class="axis-label">Value</div>
                                <div class="axis-value" *ngIf="focusedVisual.yAxisColumn">
                                    <span>{{ getFieldDisplayName(focusedVisual.yAxisColumn) }}</span>
                                    <i class="pi pi-times clear-btn" (click)="clearAxisField('y', $event)"></i>
                                </div>
                                <div class="axis-placeholder" *ngIf="!focusedVisual.yAxisColumn">
                                    <i class="pi pi-plus"></i>
                                    <span>Click to select field</span>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>


        <!-- Center Container -->
        <div class="editor-container" #canvasContainer>
            <div class="canvas-area" *ngIf="visuals.length > 0" (click)="clearFocus()">
                <div class="visual-box" *ngFor="let visual of visuals" [class.focused]="focusedVisualId === visual.id"
                    [class.disabled]="focusedVisualId !== null && focusedVisualId !== visual.id"
                    [class.dragging]="draggingVisual === visual" [style.width.px]="visual.width"
                    [style.height.px]="visual.height" draggable="true" (dragstart)="startDrag($event, visual)"
                    (dragover)="onDragOver($event, visual)" (drop)="onDrop($event, visual)"
                    (dragend)="onDragEnd($event)" (click)="onVisualClick($event, visual.id)"
                    (contextmenu)="onVisualRightClick($event, visual.id)">
                    <!-- Inline Title (shown above chart) - editable via config sidebar only -->
                    <div class="visual-inline-title">
                        <span class="inline-title-text">{{visual.title}}</span>
                        <!-- Chart type and action buttons -->
                        <div class="visual-action-buttons">
                            <button *ngIf="visual.chartType && hasRequiredChartFields(visual)" pButton
                                icon="pi pi-window-maximize" class="p-button-text p-button-sm action-btn"
                                (click)="maximizeVisual(visual, $event)" pTooltip="Maximize" tooltipPosition="top">
                            </button>
                            <button *ngIf="visual.chartType" pButton icon="pi pi-refresh"
                                class="p-button-text p-button-sm action-btn" (click)="clearChartType()"
                                pTooltip="Change chart type" tooltipPosition="top">
                            </button>
                            <button pButton icon="pi pi-times" class="p-button-text p-button-sm action-btn close-btn"
                                (click)="removeVisual(visual.id)" pTooltip="Remove" tooltipPosition="top">
                            </button>
                        </div>
                    </div>
                    <div class="visual-body">
                        <!-- Loading Placeholder -->
                        <div class="visual-loading-placeholder" *ngIf="visual.loading">
                            <div class="loading-content">
                                <i class="pi pi-spin pi-spinner loading-spinner"></i>
                                <span class="loading-text">Loading visualization...</span>
                            </div>
                        </div>

                        <!-- Error State -->
                        <div class="visual-error-placeholder" *ngIf="visual.error">
                            <div class="error-content">
                                <i class="pi pi-exclamation-triangle error-icon"></i>
                                <span class="error-text">Failed to load visualization</span>
                            </div>
                        </div>

                        <!-- Placeholder when no chart type selected (and not loading) -->
                        <div class="visual-content-placeholder"
                            *ngIf="!visual.chartType && !visual.loading && !visual.error">
                            <i class="pi pi-chart-bar"></i>
                            <p>Click to select chart type, right-click to configure</p>
                            <small>{{ visual.width }}px Ã— {{ visual.height }}px</small>
                        </div>

                        <!-- Chart Components (only show when loaded and not loading/error) -->
                        <ng-container *ngIf="!visual.loading && !visual.error && visual.chartType">
                            <!-- Bar Chart Types -->
                            <app-configurable-bar-chart *ngIf="isBarChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [chartType]="visual.chartType" [data]="visual.chartData">
                            </app-configurable-bar-chart>

                            <!-- Line Chart -->
                            <app-configurable-line-chart *ngIf="visual.chartType === 'line'" [showConfigPanel]="false"
                                [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [data]="visual.chartData">
                            </app-configurable-line-chart>

                            <!-- Area Chart Types -->
                            <app-configurable-area-chart *ngIf="isAreaChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [chartType]="visual.chartType" [data]="visual.chartData">
                            </app-configurable-area-chart>

                            <!-- Polar/Radar Chart -->
                            <app-configurable-polar-chart *ngIf="visual.chartType === 'polar'" [showConfigPanel]="false"
                                [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [data]="visual.chartData">
                            </app-configurable-polar-chart>

                            <!-- Pie Chart Types -->
                            <app-configurable-pie-chart *ngIf="isPieChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [chartType]="visual.chartType" [data]="visual.chartData">
                            </app-configurable-pie-chart>

                            <!-- Gauge Chart Types -->
                            <app-configurable-gauge-chart *ngIf="isGaugeChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [chartType]="visual.chartType" [data]="visual.chartData">
                            </app-configurable-gauge-chart>

                            <!-- Number Card Chart -->
                            <app-configurable-card-chart *ngIf="isCardChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [data]="visual.chartData">
                            </app-configurable-card-chart>

                            <!-- Heat Map Chart -->
                            <app-configurable-heatmap-chart *ngIf="isHeatMapChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [data]="visual.chartData">
                            </app-configurable-heatmap-chart>

                            <!-- Tree Map Chart -->
                            <app-configurable-treemap-chart *ngIf="isTreeMapChartType(visual.chartType)"
                                [showConfigPanel]="false" [chartWidth]="visual.width" [chartHeight]="visual.height - 45"
                                [chartConfig]="visual.config" [data]="visual.chartData">
                            </app-configurable-treemap-chart>
                        </ng-container>
                    </div>
                    <!-- Resize Handles -->
                    <div class="resize-handle-top" (mousedown)="startResize($event, visual, 'top')"></div>
                    <div class="resize-handle-right" (mousedown)="startResize($event, visual, 'right')"></div>
                    <div class="resize-handle-bottom" (mousedown)="startResize($event, visual, 'bottom')"></div>
                    <div class="resize-handle-left" (mousedown)="startResize($event, visual, 'left')"></div>
                    <div class="resize-handle-corner-br" (mousedown)="startResize($event, visual, 'bottom-right')">
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="visuals.length === 0">
                <i class="pi pi-chart-bar"></i>
                <h3>No Visuals Yet</h3>
                <p>Click the "Add Visual" button to create your first visualization</p>
                <div class="empty-state-tips">
                    <div class="tip-item">
                        <i class="pi pi-info-circle"></i>
                        <span>Click to select chart type, right-click to configure</span>
                    </div>
                    <div class="tip-item">
                        <i class="pi pi-info-circle"></i>
                        <span>Drag edges to resize</span>
                    </div>
                    <div class="tip-item">
                        <i class="pi pi-info-circle"></i>
                        <span>Right-click to configure</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Configuration Sidebar (opens on right-click only) -->
        <div class="config-sidebar" *ngIf="isConfigSidebarOpen && focusedVisualId && focusedVisual?.chartType">
            <div class="sidebar-content">
                <div class="sidebar-header-info">
                    <div class="dataset-label">Chart Configuration</div>
                    <button pButton icon="pi pi-times" class="p-button-text p-button-sm close-btn"
                        (click)="closeConfigSidebar()" title="Close"></button>
                </div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-content-inner config-form">
                    <!-- Visual Title -->
                    <div class="config-group">
                        <label>Visual Title</label>
                        <input type="text" pInputText [(ngModel)]="focusedVisual.title" maxlength="100"
                            placeholder="Enter visual title" />
                    </div>

                    <!-- Color Scheme -->
                    <div class="config-group">
                        <label>Color Scheme</label>
                        <p-dropdown [options]="colorSchemes" [(ngModel)]="focusedVisual.config.colorScheme"
                            optionLabel="label" optionValue="value" [style]="{'width': '100%'}">
                        </p-dropdown>
                    </div>

                    <!-- Axis Options (Not for pie/gauge/card charts - they don't have X/Y axes) -->
                    <div class="config-section"
                        *ngIf="!isPieChartType(focusedVisual?.chartType) && !isGaugeChartType(focusedVisual?.chartType) && !isCardChartType(focusedVisual?.chartType)">
                        <div class="section-title">Axis Options</div>
                        <div class="config-row">
                            <label>Show X Axis</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.xAxis"></p-inputSwitch>
                        </div>
                        <div class="config-row">
                            <label>Show Y Axis</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.yAxis"></p-inputSwitch>
                        </div>
                        <div class="config-row">
                            <label>Show Grid Lines</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.showGridLines"></p-inputSwitch>
                        </div>
                    </div>

                    <!-- Labels (Only for charts with traditional axes - not pie/polar) -->
                    <div class="config-section" *ngIf="hasAxisLabels(focusedVisual?.chartType)">
                        <div class="section-title">Labels</div>
                        <div class="config-row">
                            <label>Show X Axis Label</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.showXAxisLabel"></p-inputSwitch>
                        </div>
                        <div class="config-group" *ngIf="focusedVisual.config.showXAxisLabel">
                            <label>X Axis Label</label>
                            <input type="text" pInputText [(ngModel)]="focusedVisual.config.xAxisLabel" />
                        </div>
                        <div class="config-row">
                            <label>Show Y Axis Label</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.showYAxisLabel"></p-inputSwitch>
                        </div>
                        <div class="config-group" *ngIf="focusedVisual.config.showYAxisLabel">
                            <label>Y Axis Label</label>
                            <input type="text" pInputText [(ngModel)]="focusedVisual.config.yAxisLabel" />
                        </div>
                        <!-- Show Data Labels only for bar charts -->
                        <div class="config-row" *ngIf="isBarChartType(focusedVisual?.chartType)">
                            <label>Show Data Labels</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.showDataLabel"></p-inputSwitch>
                        </div>
                    </div>

                    <!-- Display Options -->
                    <div class="config-section">
                        <div class="section-title">Display Options</div>

                        <!-- Legend Options (only for charts that support legend) -->
                        <ng-container *ngIf="supportsLegend(focusedVisual?.chartType)">
                            <div class="config-row">
                                <label>Show Legend</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.legend"></p-inputSwitch>
                            </div>
                            <ng-container *ngIf="focusedVisual.config.legend">
                                <div class="config-group">
                                    <label>Legend Position</label>
                                    <p-dropdown [options]="legendPositions"
                                        [(ngModel)]="focusedVisual.config.legendPosition" optionLabel="label"
                                        optionValue="value" [style]="{'width': '100%'}">
                                    </p-dropdown>
                                </div>
                                <div class="config-group">
                                    <label>Legend Title</label>
                                    <input type="text" pInputText [(ngModel)]="focusedVisual.config.legendTitle" />
                                </div>
                            </ng-container>
                        </ng-container>

                        <!-- Styling Options -->
                        <div class="config-row"
                            *ngIf="supportsGradient(focusedVisual?.chartType) && !isBubbleChartType(focusedVisual?.chartType)">
                            <label>Gradient Fill</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.gradient"></p-inputSwitch>
                        </div>
                        <div class="config-row" *ngIf="!isBubbleChartType(focusedVisual?.chartType)">
                            <label>Animations</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.animations"></p-inputSwitch>
                        </div>
                        <div class="config-row">
                            <label>Disable Tooltip</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.tooltipDisabled"></p-inputSwitch>
                        </div>
                        <div class="config-row"
                            *ngIf="hasAxisLabels(focusedVisual?.chartType) && !isBubbleChartType(focusedVisual?.chartType)">
                            <label>Round Domains</label>
                            <p-inputSwitch [(ngModel)]="focusedVisual.config.roundDomains"></p-inputSwitch>
                        </div>

                        <!-- Bar Chart Specific Options -->
                        <ng-container *ngIf="isBarChartType(focusedVisual?.chartType)">
                            <div class="section-title" style="margin-top: 12px;">Bar Chart Options</div>
                            <div class="config-group">
                                <label>Bar Padding</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.barPadding" [min]="0" [max]="50"
                                    [showButtons]="true" [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                            <div class="config-row">
                                <label>Round Edges</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.roundEdges"></p-inputSwitch>
                            </div>
                            <div class="config-row">
                                <label>Hide Zero Bars</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.noBarWhenZero"></p-inputSwitch>
                            </div>
                        </ng-container>

                        <!-- Line Chart Specific Options -->
                        <ng-container *ngIf="focusedVisual?.chartType === 'line'">
                            <div class="config-group">
                                <label>Curve Type</label>
                                <p-dropdown [options]="curveTypes" [(ngModel)]="focusedVisual.config.curveType"
                                    optionLabel="label" optionValue="value" [style]="{'width': '100%'}">
                                </p-dropdown>
                            </div>
                            <div class="config-row">
                                <label>Auto Scale</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.autoScale"></p-inputSwitch>
                            </div>
                            <div class="config-row">
                                <label>Timeline</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.timeline"></p-inputSwitch>
                            </div>
                        </ng-container>

                        <!-- Area Chart Specific Options -->
                        <ng-container *ngIf="isAreaChartType(focusedVisual?.chartType)">
                            <div class="config-group">
                                <label>Curve Type</label>
                                <p-dropdown [options]="curveTypes" [(ngModel)]="focusedVisual.config.curveType"
                                    optionLabel="label" optionValue="value" [style]="{'width': '100%'}">
                                </p-dropdown>
                            </div>
                            <div class="config-row">
                                <label>Auto Scale</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.autoScale"></p-inputSwitch>
                            </div>
                            <div class="config-row">
                                <label>Timeline</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.timeline"></p-inputSwitch>
                            </div>
                        </ng-container>

                        <!-- Pie Chart Specific Options -->
                        <ng-container *ngIf="isPieChartType(focusedVisual?.chartType)">
                            <div class="section-title" style="margin-top: 12px;">Pie Chart Options</div>
                            <div class="config-row">
                                <label>Show Labels</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.labels"></p-inputSwitch>
                            </div>
                            <ng-container *ngIf="focusedVisual.config.labels">
                                <div class="config-row">
                                    <label>Trim Labels</label>
                                    <p-inputSwitch [(ngModel)]="focusedVisual.config.trimLabels"></p-inputSwitch>
                                </div>
                                <div class="config-group" *ngIf="focusedVisual.config.trimLabels">
                                    <label>Max Label Length</label>
                                    <p-inputNumber [(ngModel)]="focusedVisual.config.maxLabelLength" [min]="5"
                                        [max]="50" [showButtons]="true" [style]="{'width': '100%'}">
                                    </p-inputNumber>
                                </div>
                            </ng-container>
                            <div class="config-row" *ngIf="focusedVisual?.chartType === 'pie'">
                                <label>Doughnut</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.doughnut"></p-inputSwitch>
                            </div>
                            <div class="config-group"
                                *ngIf="focusedVisual.config.doughnut && focusedVisual?.chartType === 'pie'">
                                <label>Arc Width</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.arcWidth" [min]="0.1" [max]="0.9"
                                    [step]="0.05" [showButtons]="true" [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                            <div class="config-row" *ngIf="focusedVisual?.chartType === 'pie'">
                                <label>Explode Slices</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.explodeSlices"></p-inputSwitch>
                            </div>
                        </ng-container>

                        <!-- Polar Chart Specific Options -->
                        <ng-container *ngIf="focusedVisual?.chartType === 'polar'">
                            <div class="section-title" style="margin-top: 12px;">Polar Chart Options</div>
                            <div class="config-row">
                                <label>Trim Labels</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.labelTrim"></p-inputSwitch>
                            </div>
                            <div class="config-group" *ngIf="focusedVisual.config.labelTrim">
                                <label>Max Label Length</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.labelTrimSize" [min]="5" [max]="50"
                                    [showButtons]="true" [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                            <div class="config-row">
                                <label>Show Series on Hover</label>
                                <p-inputSwitch [(ngModel)]="focusedVisual.config.showSeriesOnHover"></p-inputSwitch>
                            </div>
                            <div class="config-group">
                                <label>Range Fill Opacity</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.rangeFillOpacity" [min]="0" [max]="1"
                                    [step]="0.05" [showButtons]="true" [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                        </ng-container>

                        <!-- Gauge Chart Specific Options -->
                        <ng-container *ngIf="isGaugeChartType(focusedVisual?.chartType)">
                            <div class="section-title" style="margin-top: 12px;">Gauge Chart Options</div>
                            <div class="config-group">
                                <label>Min Value</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.min" [showButtons]="true"
                                    [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                            <div class="config-group">
                                <label>Max Value</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.max" [showButtons]="true"
                                    [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                            <div class="config-group">
                                <label>Units</label>
                                <input type="text" pInputText [(ngModel)]="focusedVisual.config.units" />
                            </div>
                            <ng-container *ngIf="focusedVisual?.chartType === 'gauge'">
                                <div class="config-row">
                                    <label>Show Axis</label>
                                    <p-inputSwitch [(ngModel)]="focusedVisual.config.showAxis"></p-inputSwitch>
                                </div>
                                <div class="config-row">
                                    <label>Show Text</label>
                                    <p-inputSwitch [(ngModel)]="focusedVisual.config.showText"></p-inputSwitch>
                                </div>
                                <div class="config-group" *ngIf="focusedVisual.config.showAxis">
                                    <label>Big Segments</label>
                                    <p-inputNumber [(ngModel)]="focusedVisual.config.bigSegments" [min]="1" [max]="20"
                                        [showButtons]="true" [style]="{'width': '100%'}">
                                    </p-inputNumber>
                                </div>
                                <div class="config-group" *ngIf="focusedVisual.config.showAxis">
                                    <label>Small Segments</label>
                                    <p-inputNumber [(ngModel)]="focusedVisual.config.smallSegments" [min]="0" [max]="10"
                                        [showButtons]="true" [style]="{'width': '100%'}">
                                    </p-inputNumber>
                                </div>
                                <div class="config-group">
                                    <label>Angle Span (degrees)</label>
                                    <p-inputNumber [(ngModel)]="focusedVisual.config.angleSpan" [min]="90" [max]="360"
                                        [showButtons]="true" [style]="{'width': '100%'}">
                                    </p-inputNumber>
                                </div>
                                <div class="config-group">
                                    <label>Start Angle (degrees)</label>
                                    <p-inputNumber [(ngModel)]="focusedVisual.config.startAngle" [min]="-180"
                                        [max]="180" [showButtons]="true" [style]="{'width': '100%'}">
                                    </p-inputNumber>
                                </div>
                            </ng-container>
                        </ng-container>

                        <!-- Number Card Chart Specific Options -->
                        <ng-container *ngIf="isCardChartType(focusedVisual?.chartType)">
                            <div class="section-title" style="margin-top: 12px;">Card Options</div>
                            <div class="config-group">
                                <label>Inner Padding</label>
                                <p-inputNumber [(ngModel)]="focusedVisual.config.innerPadding" [min]="0" [max]="50"
                                    [showButtons]="true" [style]="{'width': '100%'}">
                                </p-inputNumber>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Analysis Dialog -->
<app-save-analyses-dialog [visible]="showSaveDialog" [initialName]="analysisDetails?.name"
    [initialDescription]="analysisDetails?.description" [dialogTitle]="'Update Analysis'"
    (close)="handleSaveDialogClose($event)">
</app-save-analyses-dialog>